version: '3.8'

services:
  # MongoDB for Orion-LD
  mongodb:
    image: mongo:4.4
    container_name: mongodb
    command: --bind_ip_all
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - floodwatch-net
    healthcheck:
      test: [ "CMD", "mongo", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Orion-LD Context Broker
  orion-ld:
    image: fiware/orion-ld:latest
    container_name: orion-ld
    hostname: orion-ld
    depends_on:
      mongodb:
        condition: service_healthy
    ports:
      - "1026:1026"
    command: -logLevel INFO -dbhost mongodb
    networks:
      - floodwatch-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:1026/version" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # CrateDB: Time-series + Geo-spatial database
  cratedb:
    image: crate:5.4.6
    container_name: cratedb
    ports:
      - "4200:4200"
      - "5432:5432"
    environment:
      - CRATE_HEAP_SIZE=1g
    networks:
      - floodwatch-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4200" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # QuantumLeap: subscribe Orion-LD -> CrateDB
  quantumleap:
    image: orchestracities/quantumleap:latest
    container_name: quantumleap
    depends_on:
      orion-ld:
        condition: service_healthy
      cratedb:
        condition: service_healthy
    ports:
      - "8668:8668"
    environment:
      - CRATE_HOST=cratedb
      - CRATE_PORT=4200
      - CRATE_USER=crate
      - CRATE_PASSWORD=
      - CRATE_DB=quantumleap
      - ORION_URL=http://orion-ld:1026
      - LOG_LEVEL=DEBUG
      - QL_CONFIG=/etc/quantumleap/quantumleap.yaml
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_KEY_PREFIX=ql
      - REDIS_REPLY_TIMEOUT=5
      - REDIS_RETRY_ON_TIMEOUT=true
      - REDIS_SOCKET_TIMEOUT=5
      - REDIS_CONNECT_TIMEOUT=5
      - LOG_HANDLERS=console,file
      - LOG_FILE=/var/log/quantumleap/quantumleap.log
      - LOG_FILE_MAX_SIZE=10485760
      - LOG_FILE_BACKUP_COUNT=5
    volumes:
      - ./quantumleap/quantumleap.yaml:/etc/quantumleap/quantumleap.yaml
      - quantumleap-logs:/var/log/quantumleap
    networks:
      - floodwatch-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8668/version" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # Redis for QuantumLeap caching
  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - floodwatch-net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 5
  # FastAPI Backend
  floodwatch-api:
    build:
      context: ./simulation/processor-backend/backend
      dockerfile: Dockerfile
    container_name: floodwatch-api
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - ORION_URL=http://orion-ld:1026
      - CRATEDB_HTTP_URL=http://cratedb:4200
      - CRATEDB_USER=crate
    depends_on:
      orion-ld:
        condition: service_healthy
      cratedb:
        condition: service_healthy
    networks:
      - floodwatch-net
    restart: unless-stopped

  # Subscription Manager
  subscription-manager:
    build:
      context: ./subscription
      dockerfile: Dockerfile
    container_name: floodwatch-subscription
    environment:
      - PYTHONUNBUFFERED=1
      - ORION_HOST=orion-ld
      - QL_HOST=quantumleap
      - API_HOST=floodwatch-api
    depends_on:
      orion-ld:
        condition: service_healthy
      quantumleap:
        condition: service_healthy
      floodwatch-api:
        condition: service_started
    networks:
      - floodwatch-net
    restart: on-failure

  # Water Level Simulator
  weather-simulator:
    build:
      context: ./simulation/weather_observation
      dockerfile: Dockerfile
    container_name: floodwatch-weather-simulator
    environment:
      - ORION_HOST=orion-ld
      - WEATHER_ENTITY_ID=urn:ngsi-ld:WeatherObserved:HoChiMinh_District1
      - FLOOD_ENTITY_ID=urn:ngsi-ld:FloodRiskRain:HoChiMinh_District1
      - WEATHER_LON=106.70098
      - WEATHER_LAT=10.77653
      - OPENWEATHER_KEY=${OPENWEATHER_KEY}
    depends_on:
      orion-ld:
        condition: service_healthy
      quantumleap:
        condition: service_healthy
    networks:
      - floodwatch-net
    restart: unless-stopped

  water-level-simulator:
    build:
      context: ./simulation/water_level_sensor
      dockerfile: Dockerfile
    container_name: floodwatch-water-simulator
    environment:
      - PYTHONUNBUFFERED=1
      - ORION_URL=http://orion-ld:1026/ngsi-ld/v1/
      - UPDATE_INTERVAL=10
    depends_on:
      orion-ld:
        condition: service_healthy
      subscription-manager:
        condition: service_started
    networks:
      - floodwatch-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://orion-ld:1026/version" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  floodwatch-net:
    driver: bridge

volumes:
  mongodb_data:
  grafana-storage:
  quantumleap-logs:
  redis-data:
